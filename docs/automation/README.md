# Automation Documentation

This section instructs you how to use g4blplot.automate(). For installation instructions, refer to [https://github.com/badumbatish/fermi_proj/](https://badumbatish.github.io/fermi_proj/) for documentation, including installation, general usage, development and others.
Please open up a GitHub issue (and/or) a pull request for recommendation on updating this documentation.

Ever wish you were able to tell your computer to parallel process different configurations of parameters of your G4Beamline file overnight so you can go to sleep peacefully and wake up with fresh data to process

  

Just telling it: "Hey hey hey, here are:"

* The full path of my g4bl command

* The g4bl file I want you to run

* A python dictionary that comprises of the parameters and lists (or tuples of lists) of their possible values.

* [Optional] The number of process I want my computer to spawn.

* [Optional] How many cores should each G4BLMPI batch run

* [Optional] The data directory you want automate to search and skip tasks on 

Well, here comes

```python

def automate(cmd: str, param_dict: dict, file_name : str,total_process_count = 1, mpi_count = None, detector_lst=None, data_directory=None)

```


## Explanation

The automate() function uses run_command(), generate_args() as helper functions, and multiprocessing, itertools, and subprocess as its library.

  

The helper function run_command() doesn't output anything to the terminal. It uses subprocess.run(args,stdout=subprocess.DEVNULL). Readers are advised to test out their g4bl file on low statistics first to make sure the file runs perfectly before using automate().

  

The automate() function doesn't care for existing files as it doesn't know how a detector is named. It will run the commands, rewriting the files. Be advised not to waste computing energy by reruning automate() when dealing with high statistics computation on supercomputers.

  

g4blplot.py now only supports the parallel processing part of the g4bl script, but not the data plotting and processing of all the output files generated by automate(). If more people desire the feature, maybe.

  

For data processing of multiple files, users can use itertools.product() to output a list of lists of all combinations of parameters values, then they can use calculate the length of the list as a sufficient number of subplots and histogram plots and use for-loops to plots them using the functions of g4blplot


## Set-up

### G4beamline Script Set-up

#### Parameters

In this example

* The parameter for the mean momentum is _meanMomentum

* The parameter for the mean angle of the x-axis is _meanXp

Start by adding **-unset** to all of your parameters in your .g4bl file.


```g4bl
param -unset _meanMomentum=100
param -unset _meanXp=0
```



#### Detector output

##### ASCII Formatting
*Before:*
```g4bl
virtualdetector Det radius=15.875 length=1 color=1,1,1 material=Vacuum
```

*After:*
```g4bl
virtualdetector Det radius=15.875 length=1 color=1,1,1 material=Vacuum format=ascii
```
##### Output file renaming

Place a detector at some coordinate and include a *rename* command in the same line in the g4bl script

The general (accepted by g4blplot.automate) format to format the output file name is 
```g4bl
param1$_param1|param2$_param2|param3$_param3[|post_fix]
```
where [...] is optional

The | is to separate different parameters.

The $ is to reference the value of that parameters.

For example:

```g4bl
place Det rename=_meanMomentum$_meanMomentum|_meanXp$_meanXp z=5921
```
### Python script Set-up

The script should start with

```python3
from g4bl_suite import g4blplot
```


Then the user should start by creating a parameter dictionary *param_dict* to feed it into *g4blplot.automate()*

```python3

param_dict = {

    "_meanMomentum": [100,200,300],

    "_meanXp": [-0.4,-0.2,0,0.2,0.4]
}

```

Check if the python process you are executing is main and execute the automate() function if true:

```python3

if __name__ == '__main__':

    plot.automate(cmd = "/Applications/G4beamline-3.08.app/Contents/MacOS/g4bl",
                    param_dict=param_dict,
                    file_name = "g4beamline_script/Pion_Line_BeamEllipse.g4bl",
                    total_process_count=4)
```
When you run this python program, below is its output, there should be a bar counting and update you on your computing progress (assuming you wrote the correct g4beamline script that you have tested already):

  
Here we call the python file in the root directory, with one of its subdirectory is g4beamline_script
```bash
python3 src/main.py
Creating pool with total process count = 4, pool process count = 4, G4BLMPI process count = None

Batch progress bar: 100%|████████████████████████████████████████████████████████████████████████████████| 15/15 [00:03<00:00, 4.89it/s]

```

  

You will have these files in the file directory that you run your g4bl command.

```bash

jjsm@Jasmines-MacBook-Air fermi_proj % ls det*.txt

_meanMomentum100|_meanXp-0.2.txt _meanMomentum100|_meanXp0.4.txt  _meanMomentum200|_meanXp-0.4.txt _meanMomentum200|_meanXp0.txt    _meanMomentum300|_meanXp0.2.txt
_meanMomentum100|_meanXp-0.4.txt _meanMomentum100|_meanXp0.txt    _meanMomentum200|_meanXp0.2.txt  _meanMomentum300|_meanXp-0.2.txt _meanMomentum300|_meanXp0.4.txt
_meanMomentum100|_meanXp0.2.txt  _meanMomentum200|_meanXp-0.2.txt _meanMomentum200|_meanXp0.4.txt  _meanMomentum300|_meanXp-0.4.txt _meanMomentum300|_meanXp0.txt


```

Here, we see that the g4beamline script outputs where we call the python script, not where the python script is located.

We should then cd into a data directory and call the script from there

End of documentation.
